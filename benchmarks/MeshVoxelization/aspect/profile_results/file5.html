<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" /><link rel="stylesheet" href="file:////Applications/MATLAB_R2013a.app/toolbox/matlab/codetools/matlab-report-styles.css" type="text/css" /><title>Function details for VOXELISE>VOXELISEinternal</title><link rel="stylesheet" href="file:////Applications/MATLAB_R2013a.app/toolbox/matlab/codetools/matlab-report-styles.css" type="text/css" /></head><body bgcolor="#F8F8F8"><strong>This is a static copy of a profile report</strong><p><a href="file0.html">Home</a><p><span style="font-size:14pt; background:#FFE4B0">VOXELISE>VOXELISEinternal (3 calls, 51.391 sec)</span><br/><i>Generated 29-Jan-2014 11:05:00 using cpu time.</i><br/>subfunction in file /Users/david/work/courses/621/a1/Mesh_voxelisation/aspect/VOXELISE.m<br/>Copy to new window for comparing multiple runs<div class="grayline"/><div class="grayline"/><strong>Parents</strong> (calling functions)<br/><p><table border=0 cellspacing=0 cellpadding=6><tr><td class="td-linebottomrt" bgcolor="#F0F0F0">Function Name</td><td class="td-linebottomrt" bgcolor="#F0F0F0">Function Type</td><td class="td-linebottomrt" bgcolor="#F0F0F0">Calls</td></tr><tr><td class="td-linebottomrt"><a href="file10.html">VOXELISE</a></td><td class="td-linebottomrt">function</td><td class="td-linebottomrt">3</td></tr></table><div class="grayline"/><strong>Lines where the most time was spent</strong><br/> <p><table border=0 cellspacing=0 cellpadding=6><tr><td class="td-linebottomrt" bgcolor="#F0F0F0">Line Number</td><td class="td-linebottomrt" bgcolor="#F0F0F0">Code</td><td class="td-linebottomrt" bgcolor="#F0F0F0">Calls</td><td class="td-linebottomrt" bgcolor="#F0F0F0">Total Time</td><td class="td-linebottomrt" bgcolor="#F0F0F0">% Time</td><td class="td-linebottomrt" bgcolor="#F0F0F0">Time Plot</td></tr><tr><td class="td-linebottomrt"><a href="#Line448">448</a></td><td class="td-linebottomrt"><pre>YRpredicted = (meshXYZ(loopCHE...</pre></td><td class="td-linebottomrt">186934</td><td class="td-linebottomrt">9.403 s</td><td class="td-linebottomrt" class="td-linebottomrt">18.3%</td><td class="td-linebottomrt"><img src="file:////Applications/MATLAB_R2013a.app/toolbox/matlab/codetools/private/one-pixel.gif" width=18 height=10></td></tr><tr><td class="td-linebottomrt"><a href="#Line447">447</a></td><td class="td-linebottomrt"><pre>Y1predicted = (meshXYZ(loopCHE...</pre></td><td class="td-linebottomrt">186934</td><td class="td-linebottomrt">9.046 s</td><td class="td-linebottomrt" class="td-linebottomrt">17.6%</td><td class="td-linebottomrt"><img src="file:////Applications/MATLAB_R2013a.app/toolbox/matlab/codetools/private/one-pixel.gif" width=18 height=10></td></tr><tr><td class="td-linebottomrt"><a href="#Line449">449</a></td><td class="td-linebottomrt"><pre>if (((Y1predicted &gt; meshXYZ...</pre></td><td class="td-linebottomrt">186934</td><td class="td-linebottomrt">3.664 s</td><td class="td-linebottomrt" class="td-linebottomrt">7.1%</td><td class="td-linebottomrt"><img src="file:////Applications/MATLAB_R2013a.app/toolbox/matlab/codetools/private/one-pixel.gif" width=7 height=10></td></tr><tr><td class="td-linebottomrt"><a href="#Line497">497</a></td><td class="td-linebottomrt"><pre>gridCOzCROSS = unique(gridCOzC...</pre></td><td class="td-linebottomrt">7330</td><td class="td-linebottomrt">3.469 s</td><td class="td-linebottomrt" class="td-linebottomrt">6.8%</td><td class="td-linebottomrt"><img src="file:////Applications/MATLAB_R2013a.app/toolbox/matlab/codetools/private/one-pixel.gif" width=7 height=10></td></tr><tr><td class="td-linebottomrt"><a href="#Line462">462</a></td><td class="td-linebottomrt"><pre>AM_GLOBAL.arrayGrowingAspect.a...</pre></td><td class="td-linebottomrt">12176</td><td class="td-linebottomrt">2.691 s</td><td class="td-linebottomrt" class="td-linebottomrt">5.2%</td><td class="td-linebottomrt"><img src="file:////Applications/MATLAB_R2013a.app/toolbox/matlab/codetools/private/one-pixel.gif" width=5 height=10></td></tr><tr><td class="td-linebottomrt">All other lines</td><td class="td-linebottomrt">&nbsp;</td><td class="td-linebottomrt">&nbsp;</td><td class="td-linebottomrt">23.118 s</td><td class="td-linebottomrt">45.0%</td><td class="td-linebottomrt"><img src="file:////Applications/MATLAB_R2013a.app/toolbox/matlab/codetools/private/one-pixel.gif" width=45 height=10></td></tr><tr><td class="td-linebottomrt" bgcolor="#F0F0F0">Totals</td><td class="td-linebottomrt" bgcolor="#F0F0F0">&nbsp;</td><td class="td-linebottomrt" bgcolor="#F0F0F0">&nbsp;</td><td class="td-linebottomrt" bgcolor="#F0F0F0">51.391 s</td><td class="td-linebottomrt" bgcolor="#F0F0F0">100%</td><td class="td-linebottomrt" bgcolor="#F0F0F0">&nbsp;</td></tr></table><div class="grayline"/><b>Children</b> (called functions)<br/><p><table border=0 cellspacing=0 cellpadding=6><tr><td class="td-linebottomrt" bgcolor="#F0F0F0">Function Name</td><td class="td-linebottomrt" bgcolor="#F0F0F0">Function Type</td><td class="td-linebottomrt" bgcolor="#F0F0F0">Calls</td><td class="td-linebottomrt" bgcolor="#F0F0F0">Total Time</td><td class="td-linebottomrt" bgcolor="#F0F0F0">% Time</td><td class="td-linebottomrt" bgcolor="#F0F0F0">Time Plot</td></tr><tr><td class="td-linebottomrt"><a href="file8.html">unique</a></td><td class="td-linebottomrt">function</td><td class="td-linebottomrt">7330</td><td class="td-linebottomrt">3.242 s</td><td class="td-linebottomrt">6.3%</td><td class="td-linebottomrt"><img src="file:////Applications/MATLAB_R2013a.app/toolbox/matlab/codetools/private/one-pixel.gif" width=6 height=10></td></tr><tr><td class="td-linebottomrt"><a href="file6.html">...ingAspect.arrayGrowingAspect_actFacet</a></td><td class="td-linebottomrt">subfunction</td><td class="td-linebottomrt">19506</td><td class="td-linebottomrt">3.113 s</td><td class="td-linebottomrt">6.1%</td><td class="td-linebottomrt"><img src="file:////Applications/MATLAB_R2013a.app/toolbox/matlab/codetools/private/one-pixel.gif" width=6 height=10></td></tr><tr><td class="td-linebottomrt"><a href="file3.html">...owingAspect.arrayGrowingAspect_actCor</a></td><td class="td-linebottomrt">subfunction</td><td class="td-linebottomrt">3</td><td class="td-linebottomrt">0.032 s</td><td class="td-linebottomrt">0.1%</td><td class="td-linebottomrt"><img src="file:////Applications/MATLAB_R2013a.app/toolbox/matlab/codetools/private/one-pixel.gif" width=0 height=10></td></tr><tr><td class="td-linebottomrt">Self time (built-ins, overhead, etc.)</td><td class="td-linebottomrt">&nbsp;</td><td class="td-linebottomrt">&nbsp;</td><td class="td-linebottomrt">45.004 s</td><td class="td-linebottomrt">87.6%</td><td class="td-linebottomrt"><img src="file:////Applications/MATLAB_R2013a.app/toolbox/matlab/codetools/private/one-pixel.gif" width=88 height=10></td></tr><tr><td class="td-linebottomrt" bgcolor="#F0F0F0">Totals</td><td class="td-linebottomrt" bgcolor="#F0F0F0">&nbsp;</td><td class="td-linebottomrt" bgcolor="#F0F0F0">&nbsp;</td><td class="td-linebottomrt" bgcolor="#F0F0F0">51.391 s</td><td class="td-linebottomrt" bgcolor="#F0F0F0">100%</td><td class="td-linebottomrt" bgcolor="#F0F0F0">&nbsp;</td></tr></table><div class="grayline"/><strong>Code Analyzer results</strong><br/>No Code Analyzer messages.<div class="grayline"/><strong>Coverage results</strong><br/>Show coverage for parent directory <br/><table border=0 cellspacing=0 cellpadding=6><tr><td class="td-linebottomrt" bgcolor="#F0F0F0">Total lines in function</td><td class="td-linebottomrt">233</td></tr><tr><td class="td-linebottomrt" bgcolor="#F0F0F0">Non-code lines (comments, blank lines)</td><td class="td-linebottomrt">88</td></tr><tr><td class="td-linebottomrt" bgcolor="#F0F0F0">Code lines (lines that can run)</td><td class="td-linebottomrt">145</td></tr><tr><td class="td-linebottomrt" bgcolor="#F0F0F0">Code lines that did run</td><td class="td-linebottomrt">89</td></tr><tr><td class="td-linebottomrt" bgcolor="#F0F0F0">Code lines that did not run</td><td class="td-linebottomrt">56</td></tr><tr><td class="td-linebottomrt" bgcolor="#F0F0F0">Coverage (did run/can run)</td><td class="td-linebottomrt">61.38 %</td></tr></table><div class="grayline"/><b>Function listing</b><br/><pre> <span style="color: #FF0000; font-weight: bold; text-decoration: none">  time</span> <span style="color: #0000FF; font-weight: bold; text-decoration: none">  calls</span>  <span style="font-weight: bold; text-decoration: none">line</span><br/>               <span style="color: #A0A0A0"> 328</span> <span style="color: #A0A0A0; background: #FFFFFF;">function [gridOUTPUT] = VOXELISEinternal(gridCOx, gridCOy, gridCOz, meshXYZ)</span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 329</span> <span style="color: #000000; background: #FFFFFF;">  global AM_GLOBAL; </span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 330</span> <span style="color: #000000; background: #FFFFFF;">  if isempty(AM_GLOBAL) </span><br/>               <span style="color: #A0A0A0"> 331</span> <span style="color: #A0A0A0; background: #FFFFFF;">    AM_GLOBAL.arrayGrowingAspect = arrayGrowingAspect;</span><br/>               <span style="color: #A0A0A0"> 332</span> <span style="color: #A0A0A0; background: #FFFFFF;">    AM_EntryPoint_1 = 1;</span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 333</span> <span style="color: #228B22; background: #FFFFFF;">  else  </span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 334</span> <span style="color: #000000; background: #FFFFFF;">    AM_EntryPoint_1 = 0; </span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 335</span> <span style="color: #000000; background: #FFFFFF;">  end </span><br/>               <span style="color: #A0A0A0"> 336</span> <span style="color: #228B22; background: #FFFFFF;">%==========================================================================</span><br/>               <span style="color: #A0A0A0"> 337</span> <span style="color: #228B22; background: #FFFFFF;">  %==========================================================================</span><br/>               <span style="color: #A0A0A0"> 338</span> <span style="color: #228B22; background: #FFFFFF;">%Count the number of voxels in each direction:</span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 339</span> <span style="color: #000000; background: #FFFFFF;">  voxcountX = numel(gridCOx); </span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 340</span> <span style="color: #000000; background: #FFFFFF;">  voxcountY = numel(gridCOy); </span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 341</span> <span style="color: #000000; background: #FFFFFF;">  voxcountZ = numel(gridCOz); </span><br/>               <span style="color: #A0A0A0"> 342</span> <span style="color: #228B22; background: #FFFFFF;">% Prepare logical array to hold the voxelised data:</span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 343</span> <span style="color: #000000; background: #FFFFFF;">  gridOUTPUT = false(voxcountX, voxcountY, voxcountZ); </span><br/>               <span style="color: #A0A0A0"> 344</span> <span style="color: #228B22; background: #FFFFFF;">%Identify the min and max x,y coordinates (cm) of the mesh:</span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 345</span> <span style="color: #000000; background: #FFFFFF;">  meshXmin = min(min(meshXYZ(:, 1, :))); </span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 346</span> <span style="color: #000000; background: #FFFFFF;">  meshXmax = max(max(meshXYZ(:, 1, :))); </span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 347</span> <span style="color: #000000; background: #FFFFFF;">  meshYmin = min(min(meshXYZ(:, 2, :))); </span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 348</span> <span style="color: #000000; background: #FFFFFF;">  meshYmax = max(max(meshXYZ(:, 2, :))); </span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 349</span> <span style="color: #000000; background: #FFFFFF;">  meshZmin = min(min(meshXYZ(:, 3, :))); </span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 350</span> <span style="color: #000000; background: #FFFFFF;">  meshZmax = max(max(meshXYZ(:, 3, :))); </span><br/>               <span style="color: #A0A0A0"> 351</span> <span style="color: #228B22; background: #FFFFFF;">%Identify the min and max x,y coordinates (pixels) of the mesh:</span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 352</span> <span style="color: #000000; background: #FFFFFF;">  meshXminp = find((abs((gridCOx - meshXmin)) == min(abs((gridCOx - meshXmin))))); </span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 353</span> <span style="color: #000000; background: #FFFFFF;">  meshXmaxp = find((abs((gridCOx - meshXmax)) == min(abs((gridCOx - meshXmax))))); </span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 354</span> <span style="color: #000000; background: #FFFFFF;">  meshYminp = find((abs((gridCOy - meshYmin)) == min(abs((gridCOy - meshYmin))))); </span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 355</span> <span style="color: #000000; background: #FFFFFF;">  meshYmaxp = find((abs((gridCOy - meshYmax)) == min(abs((gridCOy - meshYmax))))); </span><br/>               <span style="color: #A0A0A0"> 356</span> <span style="color: #228B22; background: #FFFFFF;">%Make sure min &lt; max for the mesh coordinates:</span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 357</span> <span style="color: #000000; background: #FFFFFF;">  if (meshXminp &gt; meshXmaxp) </span><br/>               <span style="color: #A0A0A0"> 358</span> <span style="color: #A0A0A0; background: #FFFFFF;">    [meshXminp, meshXmaxp] = deal(meshXmaxp, meshXminp);</span><br/>               <span style="color: #A0A0A0"> 359</span> <span style="color: #A0A0A0; background: #FFFFFF;">  end  %if</span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 360</span> <span style="color: #000000; background: #FFFFFF;">  if (meshYminp &gt; meshYmaxp) </span><br/>               <span style="color: #A0A0A0"> 361</span> <span style="color: #A0A0A0; background: #FFFFFF;">    [meshYminp, meshYmaxp] = deal(meshYmaxp, meshYminp);</span><br/>               <span style="color: #A0A0A0"> 362</span> <span style="color: #A0A0A0; background: #FFFFFF;">  end  %if</span><br/>               <span style="color: #A0A0A0"> 363</span> <span style="color: #228B22; background: #FFFFFF;">%Identify the min and max x,y,z coordinates of each facet:</span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 364</span> <span style="color: #000000; background: #FFFFFF;">  meshXYZmin = min(meshXYZ, [], 3); </span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 365</span> <span style="color: #000000; background: #FFFFFF;">  meshXYZmax = max(meshXYZ, [], 3); </span><br/>               <span style="color: #A0A0A0"> 366</span> <span style="color: #228B22; background: #FFFFFF;">%======================================================</span><br/>               <span style="color: #A0A0A0"> 367</span> <span style="color: #228B22; background: #FFFFFF;">% VOXELISE THE MESH</span><br/>               <span style="color: #A0A0A0"> 368</span> <span style="color: #228B22; background: #FFFFFF;">%======================================================</span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 369</span> <span style="color: #000000; background: #FFFFFF;">  AM_CVar_2 = []; </span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 370</span> <span style="color: #000000; background: #FFFFFF;">  correctionLIST = AM_CVar_2;  %Prepare to record all rays that fail the voxelisation.  This array is built on-the-fly, but since </span><br/><span style="color: #FF0000">  0.03 </span><span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 371</span> <span style="color: #000000; background: #FFFFFF;">  AM_GLOBAL.arrayGrowingAspect.arrayGrowingAspect_actCor(AM_CVar_2); </span><br/>               <span style="color: #A0A0A0"> 372</span> <span style="color: #228B22; background: #FFFFFF;">%it ought to be relatively small should not incur too much of a speed penalty.</span><br/>               <span style="color: #A0A0A0"> 373</span> <span style="color: #228B22; background: #FFFFFF;">% Loop through each x,y pixel.</span><br/>               <span style="color: #A0A0A0"> 374</span> <span style="color: #228B22; background: #FFFFFF;">% The mesh will be voxelised by passing rays in the z-direction through</span><br/>               <span style="color: #A0A0A0"> 375</span> <span style="color: #228B22; background: #FFFFFF;">% each x,y pixel, and finding the locations where the rays cross the mesh.</span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 376</span> <span style="color: #000000; background: #FFFFFF;">  AM_tmpAS_loopY = (meshYminp : meshYmaxp); </span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 377</span> <span style="color: #000000; background: #FFFFFF;">  for AM_tmpFS_loopY = (1 : length(AM_tmpAS_loopY(:, :))) </span><br/>       <span style="color: #0000FF">    152 </span><span style="color: #000000; font-weight: bold"> 378</span> <span style="color: #000000; background: #FFFFFF;">    loopY = AM_tmpAS_loopY(:, AM_tmpFS_loopY); </span><br/>               <span style="color: #A0A0A0"> 379</span> <span style="color: #228B22; background: #FFFFFF;">% - 1a - Find which mesh facets could possibly be crossed by the ray:</span><br/>       <span style="color: #0000FF">    152 </span><span style="color: #000000; font-weight: bold"> 380</span> <span style="color: #000000; background: #FFFFFF;">    possibleCROSSLISTy = find(((meshXYZmin(:, 2) &lt;= gridCOy(loopY)) &amp; (meshXYZmax(:, 2) &gt;= gridCOy(loopY)))); </span><br/>       <span style="color: #0000FF">    152 </span><span style="color: #000000; font-weight: bold"> 381</span> <span style="color: #000000; background: #FFFFFF;">    AM_tmpAS_loopX = (meshXminp : meshXmaxp); </span><br/>       <span style="color: #0000FF">    152 </span><span style="color: #000000; font-weight: bold"> 382</span> <span style="color: #000000; background: #FFFFFF;">    for AM_tmpFS_loopX = (1 : length(AM_tmpAS_loopX(:, :))) </span><br/>       <span style="color: #0000FF">   7700 </span><span style="color: #000000; font-weight: bold"> 383</span> <span style="color: #000000; background: #FFFFFF;">      loopX = AM_tmpAS_loopX(:, AM_tmpFS_loopX); </span><br/>               <span style="color: #A0A0A0"> 384</span> <span style="color: #228B22; background: #FFFFFF;">% - 1b - Find which mesh facets could possibly be crossed by the ray:</span><br/><span style="color: #FF0000">  0.32 </span><span style="color: #0000FF">   7700 </span><span style="color: #000000; font-weight: bold"> 385</span> <span style="color: #000000; background: #FFFFFF;">      possibleCROSSLIST = possibleCROSSLISTy(((meshXYZmin(possibleCROSSLISTy, 1) &lt;= gridCOx(loopX)) &amp; (meshXYZmax(possibleCROSSLISTy, 1) &gt;= gridCOx(loopX)))); </span><br/><span style="color: #FF0000">  0.16 </span><span style="color: #0000FF">   7700 </span><span style="color: #000000; font-weight: bold"> 386</span> <span style="color: #000000; background: #FFFFFF;">      if (isempty(possibleCROSSLIST) == 0) </span><br/>               <span style="color: #A0A0A0"> 387</span> <span style="color: #228B22; background: #FFFFFF;">%Only continue the analysis if some nearby facets were actually identified</span><br/>               <span style="color: #A0A0A0"> 388</span> <span style="color: #228B22; background: #FFFFFF;">% - 2 - For each facet, check if the ray really does cross the facet rather than just passing it close-by:</span><br/>               <span style="color: #A0A0A0"> 389</span> <span style="color: #228B22; background: #FFFFFF;">% GENERAL METHOD:</span><br/>               <span style="color: #A0A0A0"> 390</span> <span style="color: #228B22; background: #FFFFFF;">% A. Take each edge of the facet in turn.</span><br/>               <span style="color: #A0A0A0"> 391</span> <span style="color: #228B22; background: #FFFFFF;">% B. Find the position of the opposing vertex to that edge.</span><br/>               <span style="color: #A0A0A0"> 392</span> <span style="color: #228B22; background: #FFFFFF;">% C. Find the position of the ray relative to that edge.</span><br/>               <span style="color: #A0A0A0"> 393</span> <span style="color: #228B22; background: #FFFFFF;">% D. Check if ray is on the same side of the edge as the opposing vertex.</span><br/>               <span style="color: #A0A0A0"> 394</span> <span style="color: #228B22; background: #FFFFFF;">% E. If this is true for all three edges, then the ray definitely passes through the facet.</span><br/>               <span style="color: #A0A0A0"> 395</span> <span style="color: #228B22; background: #FFFFFF;">%</span><br/>               <span style="color: #A0A0A0"> 396</span> <span style="color: #228B22; background: #FFFFFF;">% NOTES:</span><br/>               <span style="color: #A0A0A0"> 397</span> <span style="color: #228B22; background: #FFFFFF;">% A. If a ray crosses exactly on a vertex:</span><br/>               <span style="color: #A0A0A0"> 398</span> <span style="color: #228B22; background: #FFFFFF;">%    a. If the surrounding facets have normal components pointing in the same (or opposite) direction as the ray then the face IS crossed.</span><br/>               <span style="color: #A0A0A0"> 399</span> <span style="color: #228B22; background: #FFFFFF;">%    b. Otherwise, add the ray to the correctionlist.</span><br/><span style="color: #FF0000">  0.06 </span><span style="color: #0000FF">   7330 </span><span style="color: #000000; font-weight: bold"> 400</span> <span style="color: #000000; background: #FFFFFF;">        AM_CVar_3 = []; </span><br/><span style="color: #FF0000">  0.10 </span><span style="color: #0000FF">   7330 </span><span style="color: #000000; font-weight: bold"> 401</span> <span style="color: #000000; background: #FFFFFF;">        facetCROSSLIST = AM_CVar_3;  %Prepare to record all facets which are crossed by the ray.  This array is built on-the-fly, but since </span><br/><span style="color: #FF0000">  1.62 </span><span style="color: #0000FF">   7330 </span><span style="color: #000000; font-weight: bold"> 402</span> <span style="color: #000000; background: #FFF0F0;">        AM_GLOBAL.arrayGrowingAspect.arrayGrowingAspect_actFacet(AM_CVar_3); </span><br/>               <span style="color: #A0A0A0"> 403</span> <span style="color: #228B22; background: #FFFFFF;">%it ought to be relatively small (typically a list of &lt;10) should not incur too much of a speed penalty.</span><br/>               <span style="color: #A0A0A0"> 404</span> <span style="color: #228B22; background: #FFFFFF;">%----------</span><br/>               <span style="color: #A0A0A0"> 405</span> <span style="color: #228B22; background: #FFFFFF;">% - 1 - Check for crossed vertices:</span><br/>               <span style="color: #A0A0A0"> 406</span> <span style="color: #228B22; background: #FFFFFF;">%----------</span><br/>               <span style="color: #A0A0A0"> 407</span> <span style="color: #228B22; background: #FFFFFF;">% Find which mesh facets contain a vertex which is crossed by the ray:</span><br/><span style="color: #FF0000">  0.58 </span><span style="color: #0000FF">   7330 </span><span style="color: #000000; font-weight: bold"> 408</span> <span style="color: #000000; background: #FFFFFF;">        vertexCROSSLIST = possibleCROSSLIST(((((meshXYZ(possibleCROSSLIST, 1, 1) == gridCOx(loopX)) &amp; (meshXYZ(possibleCROSSLIST, 2, 1) == gridCOy(loopY))) | ((meshXYZ(possibleCROSSLIST, 1, 2) == gridCOx(loopX)) &amp; (meshXYZ(possibleCROSSLIST, 2, 2) == gridCOy(loopY)))) | ((meshXYZ(possibleCROSSLIST, 1, 3) == gridCOx(loopX)) &amp; (meshXYZ(possibleCROSSLIST, 2, 3) == gridCOy(loopY)))));  ... </span><br/>               <span style="color: #A0A0A0"> 409</span> <span style="color: #228B22; background: #FFFFFF;">        ...</span><br/>               <span style="color: #A0A0A0"> 410</span> <span style="color: #228B22; background: #FFFFFF;">        ...</span><br/><span style="color: #FF0000">  0.06 </span><span style="color: #0000FF">   7330 </span><span style="color: #000000; font-weight: bold"> 411</span> <span style="color: #000000; background: #FFFFFF;">        if (isempty(vertexCROSSLIST) == 0) </span><br/>               <span style="color: #A0A0A0"> 412</span> <span style="color: #228B22; background: #FFFFFF;">%Only continue the analysis if potential vertices were actually identified</span><br/>               <span style="color: #A0A0A0"> 413</span> <span style="color: #A0A0A0; background: #FFFFFF;">          checkindex = zeros(1, numel(vertexCROSSLIST));</span><br/>               <span style="color: #A0A0A0"> 414</span> <span style="color: #A0A0A0; background: #FFFFFF;">            AM_CVar_0 = (min(checkindex) == 0);</span><br/>               <span style="color: #A0A0A0"> 415</span> <span style="color: #A0A0A0; background: #FFFFFF;">          while AM_CVar_0</span><br/>               <span style="color: #A0A0A0"> 416</span> <span style="color: #A0A0A0; background: #FFFFFF;">            vertexindex = find((checkindex == 0), 1, 'first');</span><br/>               <span style="color: #A0A0A0"> 417</span> <span style="color: #A0A0A0; background: #FFFFFF;">            checkindex(vertexindex) = 1;</span><br/>               <span style="color: #A0A0A0"> 418</span> <span style="color: #A0A0A0; background: #FFFFFF;">            [temp.faces, temp.vertices] = CONVERT_meshformat(meshXYZ(vertexCROSSLIST, :, :));</span><br/>               <span style="color: #A0A0A0"> 419</span> <span style="color: #A0A0A0; background: #FFFFFF;">            adjacentindex = ismember(temp.faces, temp.faces(vertexindex, :));</span><br/>               <span style="color: #A0A0A0"> 420</span> <span style="color: #A0A0A0; background: #FFFFFF;">            adjacentindex = max(adjacentindex, [], 2);</span><br/>               <span style="color: #A0A0A0"> 421</span> <span style="color: #A0A0A0; background: #FFFFFF;">            checkindex(adjacentindex) = 1;</span><br/>               <span style="color: #A0A0A0"> 422</span> <span style="color: #A0A0A0; background: #FFFFFF;">            coN = COMPUTE_mesh_normals(meshXYZ(vertexCROSSLIST(adjacentindex), :, :));</span><br/>               <span style="color: #A0A0A0"> 423</span> <span style="color: #A0A0A0; background: #FFFFFF;">            if ((max(coN(:, 3)) &lt; 0) || (min(coN(:, 3)) &gt; 0))</span><br/>               <span style="color: #A0A0A0"> 424</span> <span style="color: #A0A0A0; background: #FFFFFF;">              AM_CVar_4 = [facetCROSSLIST, vertexCROSSLIST(vertexindex)];</span><br/>               <span style="color: #A0A0A0"> 425</span> <span style="color: #A0A0A0; background: #FFFFFF;">              facetCROSSLIST = AM_CVar_4;</span><br/>               <span style="color: #A0A0A0"> 426</span> <span style="color: #A0A0A0; background: #FFFFFF;">              AM_GLOBAL.arrayGrowingAspect.arrayGrowingAspect_actFacet(AM_CVar_4);</span><br/>               <span style="color: #A0A0A0"> 427</span> <span style="color: #228B22; background: #FFFFFF;">            else </span><br/>               <span style="color: #A0A0A0"> 428</span> <span style="color: #A0A0A0; background: #FFFFFF;">              possibleCROSSLIST = [];</span><br/>               <span style="color: #A0A0A0"> 429</span> <span style="color: #A0A0A0; background: #FFFFFF;">              AM_CVar_5 = [correctionLIST; loopX, loopY];</span><br/>               <span style="color: #A0A0A0"> 430</span> <span style="color: #A0A0A0; background: #FFFFFF;">              correctionLIST = AM_CVar_5;</span><br/>               <span style="color: #A0A0A0"> 431</span> <span style="color: #A0A0A0; background: #FFFFFF;">              AM_GLOBAL.arrayGrowingAspect.arrayGrowingAspect_actCor(AM_CVar_5);</span><br/>               <span style="color: #A0A0A0"> 432</span> <span style="color: #A0A0A0; background: #FFFFFF;">              checkindex(:) = 1;</span><br/>               <span style="color: #A0A0A0"> 433</span> <span style="color: #A0A0A0; background: #FFFFFF;">            end</span><br/>               <span style="color: #A0A0A0"> 434</span> <span style="color: #A0A0A0; background: #FFFFFF;">            AM_CVar_0 = (min(checkindex) == 0);</span><br/>               <span style="color: #A0A0A0"> 435</span> <span style="color: #A0A0A0; background: #FFFFFF;">          end</span><br/>               <span style="color: #A0A0A0"> 436</span> <span style="color: #A0A0A0; background: #FFFFFF;">        end</span><br/>               <span style="color: #A0A0A0"> 437</span> <span style="color: #228B22; background: #FFFFFF;">%----------</span><br/>               <span style="color: #A0A0A0"> 438</span> <span style="color: #228B22; background: #FFFFFF;">% - 2 - Check for crossed facets:</span><br/>               <span style="color: #A0A0A0"> 439</span> <span style="color: #228B22; background: #FFFFFF;">%----------</span><br/><span style="color: #FF0000">  0.03 </span><span style="color: #0000FF">   7330 </span><span style="color: #000000; font-weight: bold"> 440</span> <span style="color: #000000; background: #FFFFFF;">        if (isempty(possibleCROSSLIST) == 0) </span><br/>               <span style="color: #A0A0A0"> 441</span> <span style="color: #228B22; background: #FFFFFF;">%Only continue the analysis if some nearby facets were actually identified</span><br/><span style="color: #FF0000">  0.10 </span><span style="color: #0000FF">   7330 </span><span style="color: #000000; font-weight: bold"> 442</span> <span style="color: #000000; background: #FFFFFF;">          AM_tmpAS_loopCHECKFACET = (possibleCROSSLIST'); </span><br/><span style="color: #FF0000">  0.42 </span><span style="color: #0000FF">   7330 </span><span style="color: #000000; font-weight: bold"> 443</span> <span style="color: #000000; background: #FFFFFF;">          for AM_tmpFS_loopCHECKFACET = (1 : length(AM_tmpAS_loopCHECKFACET(:, :))) </span><br/><span style="color: #FF0000">  2.01 </span><span style="color: #0000FF"> 186934 </span><span style="color: #000000; font-weight: bold"> 444</span> <span style="color: #000000; background: #FFE2E2;">            loopCHECKFACET = AM_tmpAS_loopCHECKFACET(:, AM_tmpFS_loopCHECKFACET); </span><br/>               <span style="color: #A0A0A0"> 445</span> <span style="color: #228B22; background: #FFFFFF;">%Check if ray crosses the facet.  This method is much (&gt;&gt;10 times) faster than using the built-in function 'inpolygon'.</span><br/>               <span style="color: #A0A0A0"> 446</span> <span style="color: #228B22; background: #FFFFFF;">%Taking each edge of the facet in turn, check if the ray is on the same side as the opposing vertex.</span><br/><span style="color: #FF0000">  9.05 </span><span style="color: #0000FF"> 186934 </span><span style="color: #000000; font-weight: bold"> 447</span> <a name="Line447"></a><span style="color: #000000; background: #FF8080;">            Y1predicted = (meshXYZ(loopCHECKFACET, 2, 2) - (((meshXYZ(loopCHECKFACET, 2, 2) - meshXYZ(loopCHECKFACET, 2, 3)) * (meshXYZ(loopCHECKFACET, 1, 2) - meshXYZ(loopCHECKFACET, 1, 1))) / (meshXYZ(loopCHECKFACET, 1, 2) - meshXYZ(loopCHECKFACET, 1, 3)))); </span><br/><span style="color: #FF0000">  9.40 </span><span style="color: #0000FF"> 186934 </span><span style="color: #000000; font-weight: bold"> 448</span> <a name="Line448"></a><span style="color: #000000; background: #FF8080;">            YRpredicted = (meshXYZ(loopCHECKFACET, 2, 2) - (((meshXYZ(loopCHECKFACET, 2, 2) - meshXYZ(loopCHECKFACET, 2, 3)) * (meshXYZ(loopCHECKFACET, 1, 2) - gridCOx(loopX))) / (meshXYZ(loopCHECKFACET, 1, 2) - meshXYZ(loopCHECKFACET, 1, 3)))); </span><br/><span style="color: #FF0000">  3.66 </span><span style="color: #0000FF"> 186934 </span><span style="color: #000000; font-weight: bold"> 449</span> <a name="Line449"></a><span style="color: #000000; background: #FFD4D4;">            if (((Y1predicted &gt; meshXYZ(loopCHECKFACET, 2, 1)) &amp;&amp; (YRpredicted &gt; gridCOy(loopY))) || ((Y1predicted &lt; meshXYZ(loopCHECKFACET, 2, 1)) &amp;&amp; (YRpredicted &lt; gridCOy(loopY)))) </span><br/>               <span style="color: #A0A0A0"> 450</span> <span style="color: #228B22; background: #FFFFFF;">%The ray is on the same side of the 2-3 edge as the 1st vertex.</span><br/><span style="color: #FF0000">  0.91 </span><span style="color: #0000FF"> 138942 </span><span style="color: #000000; font-weight: bold"> 451</span> <span style="color: #000000; background: #FFFFFF;">              Y2predicted = (meshXYZ(loopCHECKFACET, 2, 3) - (((meshXYZ(loopCHECKFACET, 2, 3) - meshXYZ(loopCHECKFACET, 2, 1)) * (meshXYZ(loopCHECKFACET, 1, 3) - meshXYZ(loopCHECKFACET, 1, 2))) / (meshXYZ(loopCHECKFACET, 1, 3) - meshXYZ(loopCHECKFACET, 1, 1)))); </span><br/><span style="color: #FF0000">  1.23 </span><span style="color: #0000FF"> 138942 </span><span style="color: #000000; font-weight: bold"> 452</span> <span style="color: #000000; background: #FFF0F0;">              YRpredicted = (meshXYZ(loopCHECKFACET, 2, 3) - (((meshXYZ(loopCHECKFACET, 2, 3) - meshXYZ(loopCHECKFACET, 2, 1)) * (meshXYZ(loopCHECKFACET, 1, 3) - gridCOx(loopX))) / (meshXYZ(loopCHECKFACET, 1, 3) - meshXYZ(loopCHECKFACET, 1, 1)))); </span><br/><span style="color: #FF0000">  2.69 </span><span style="color: #0000FF"> 138942 </span><span style="color: #000000; font-weight: bold"> 453</span> <span style="color: #000000; background: #FFE2E2;">              if (((Y2predicted &gt; meshXYZ(loopCHECKFACET, 2, 2)) &amp;&amp; (YRpredicted &gt; gridCOy(loopY))) || ((Y2predicted &lt; meshXYZ(loopCHECKFACET, 2, 2)) &amp;&amp; (YRpredicted &lt; gridCOy(loopY)))) </span><br/>               <span style="color: #A0A0A0"> 454</span> <span style="color: #228B22; background: #FFFFFF;">%The ray is on the same side of the 3-1 edge as the 2nd vertex.</span><br/><span style="color: #FF0000">  0.65 </span><span style="color: #0000FF">  51956 </span><span style="color: #000000; font-weight: bold"> 455</span> <span style="color: #000000; background: #FFFFFF;">                Y3predicted = (meshXYZ(loopCHECKFACET, 2, 1) - (((meshXYZ(loopCHECKFACET, 2, 1) - meshXYZ(loopCHECKFACET, 2, 2)) * (meshXYZ(loopCHECKFACET, 1, 1) - meshXYZ(loopCHECKFACET, 1, 3))) / (meshXYZ(loopCHECKFACET, 1, 1) - meshXYZ(loopCHECKFACET, 1, 2)))); </span><br/><span style="color: #FF0000">  0.55 </span><span style="color: #0000FF">  51956 </span><span style="color: #000000; font-weight: bold"> 456</span> <span style="color: #000000; background: #FFFFFF;">                YRpredicted = (meshXYZ(loopCHECKFACET, 2, 1) - (((meshXYZ(loopCHECKFACET, 2, 1) - meshXYZ(loopCHECKFACET, 2, 2)) * (meshXYZ(loopCHECKFACET, 1, 1) - gridCOx(loopX))) / (meshXYZ(loopCHECKFACET, 1, 1) - meshXYZ(loopCHECKFACET, 1, 2)))); </span><br/><span style="color: #FF0000">  0.65 </span><span style="color: #0000FF">  51956 </span><span style="color: #000000; font-weight: bold"> 457</span> <span style="color: #000000; background: #FFFFFF;">                if (((Y3predicted &gt; meshXYZ(loopCHECKFACET, 2, 3)) &amp;&amp; (YRpredicted &gt; gridCOy(loopY))) || ((Y3predicted &lt; meshXYZ(loopCHECKFACET, 2, 3)) &amp;&amp; (YRpredicted &lt; gridCOy(loopY)))) </span><br/>               <span style="color: #A0A0A0"> 458</span> <span style="color: #228B22; background: #FFFFFF;">%The ray is on the same side of the 1-2 edge as the 3rd vertex.</span><br/>               <span style="color: #A0A0A0"> 459</span> <span style="color: #228B22; background: #FFFFFF;">%The ray passes through the facet since it is on the correct side of all 3 edges</span><br/><span style="color: #FF0000">  0.19 </span><span style="color: #0000FF">  12176 </span><span style="color: #000000; font-weight: bold"> 460</span> <span style="color: #000000; background: #FFFFFF;">                  AM_CVar_6 = [facetCROSSLIST, loopCHECKFACET]; </span><br/><span style="color: #FF0000">  0.16 </span><span style="color: #0000FF">  12176 </span><span style="color: #000000; font-weight: bold"> 461</span> <span style="color: #000000; background: #FFFFFF;">                  facetCROSSLIST = AM_CVar_6; </span><br/><span style="color: #FF0000">  2.69 </span><span style="color: #0000FF">  12176 </span><span style="color: #000000; font-weight: bold"> 462</span> <a name="Line462"></a><span style="color: #000000; background: #FFE2E2;">                  AM_GLOBAL.arrayGrowingAspect.arrayGrowingAspect_actFacet(AM_CVar_6); </span><br/><span style="color: #FF0000">  0.13 </span><span style="color: #0000FF">  12176 </span><span style="color: #000000; font-weight: bold"> 463</span> <span style="color: #000000; background: #FFFFFF;">                end  %if </span><br/><span style="color: #FF0000">  0.42 </span><span style="color: #0000FF">  51956 </span><span style="color: #000000; font-weight: bold"> 464</span> <span style="color: #000000; background: #FFFFFF;">              end  %if </span><br/><span style="color: #FF0000">  1.07 </span><span style="color: #0000FF"> 138942 </span><span style="color: #000000; font-weight: bold"> 465</span> <span style="color: #000000; background: #FFF0F0;">            end  %if </span><br/><span style="color: #FF0000">  2.37 </span><span style="color: #0000FF"> 186934 </span><span style="color: #000000; font-weight: bold"> 466</span> <span style="color: #000000; background: #FFE2E2;">          end </span><br/>               <span style="color: #A0A0A0"> 467</span> <span style="color: #228B22; background: #FFFFFF;">%----------</span><br/>               <span style="color: #A0A0A0"> 468</span> <span style="color: #228B22; background: #FFFFFF;">% - 3 - Find the z coordinate of the locations where the ray crosses each facet or vertex:</span><br/>               <span style="color: #A0A0A0"> 469</span> <span style="color: #228B22; background: #FFFFFF;">%----------</span><br/><span style="color: #FF0000">  0.10 </span><span style="color: #0000FF">   7330 </span><span style="color: #000000; font-weight: bold"> 470</span> <span style="color: #000000; background: #FFFFFF;">          gridCOzCROSS = zeros(size(facetCROSSLIST)); </span><br/><span style="color: #FF0000">  0.03 </span><span style="color: #0000FF">   7330 </span><span style="color: #000000; font-weight: bold"> 471</span> <span style="color: #000000; background: #FFFFFF;">          AM_tmpAS_loopFINDZ = facetCROSSLIST; </span><br/><span style="color: #FF0000">  0.36 </span><span style="color: #0000FF">   7330 </span><span style="color: #000000; font-weight: bold"> 472</span> <span style="color: #000000; background: #FFFFFF;">          for AM_tmpFS_loopFINDZ = (1 : length(AM_tmpAS_loopFINDZ(:, :))) </span><br/><span style="color: #FF0000">  0.10 </span><span style="color: #0000FF">  12176 </span><span style="color: #000000; font-weight: bold"> 473</span> <span style="color: #000000; background: #FFFFFF;">            loopFINDZ = AM_tmpAS_loopFINDZ(:, AM_tmpFS_loopFINDZ); </span><br/>               <span style="color: #A0A0A0"> 474</span> <span style="color: #228B22; background: #FFFFFF;">% METHOD:</span><br/>               <span style="color: #A0A0A0"> 475</span> <span style="color: #228B22; background: #FFFFFF;">% 1. Define the equation describing the plane of the facet.  For a</span><br/>               <span style="color: #A0A0A0"> 476</span> <span style="color: #228B22; background: #FFFFFF;">% more detailed outline of the maths, see:</span><br/>               <span style="color: #A0A0A0"> 477</span> <span style="color: #228B22; background: #FFFFFF;">% http://local.wasp.uwa.edu.au/~pbourke/geometry/planeeq/</span><br/>               <span style="color: #A0A0A0"> 478</span> <span style="color: #228B22; background: #FFFFFF;">%    Ax + By + Cz + D = 0</span><br/>               <span style="color: #A0A0A0"> 479</span> <span style="color: #228B22; background: #FFFFFF;">%    where  A = y1 (z2 - z3) + y2 (z3 - z1) + y3 (z1 - z2)</span><br/>               <span style="color: #A0A0A0"> 480</span> <span style="color: #228B22; background: #FFFFFF;">%           B = z1 (x2 - x3) + z2 (x3 - x1) + z3 (x1 - x2)</span><br/>               <span style="color: #A0A0A0"> 481</span> <span style="color: #228B22; background: #FFFFFF;">%           C = x1 (y2 - y3) + x2 (y3 - y1) + x3 (y1 - y2)</span><br/>               <span style="color: #A0A0A0"> 482</span> <span style="color: #228B22; background: #FFFFFF;">%           D = - x1 (y2 z3 - y3 z2) - x2 (y3 z1 - y1 z3) - x3 (y1 z2 - y2 z1)</span><br/>               <span style="color: #A0A0A0"> 483</span> <span style="color: #228B22; background: #FFFFFF;">% 2. For the x and y coordinates of the ray, solve these equations to find the z coordinate in this plane.</span><br/><span style="color: #FF0000">  0.88 </span><span style="color: #0000FF">  12176 </span><span style="color: #000000; font-weight: bold"> 484</span> <span style="color: #000000; background: #FFFFFF;">            planecoA = (((meshXYZ(loopFINDZ, 2, 1) * (meshXYZ(loopFINDZ, 3, 2) - meshXYZ(loopFINDZ, 3, 3))) + (meshXYZ(loopFINDZ, 2, 2) * (meshXYZ(loopFINDZ, 3, 3) - meshXYZ(loopFINDZ, 3, 1)))) + (meshXYZ(loopFINDZ, 2, 3) * (meshXYZ(loopFINDZ, 3, 1) - meshXYZ(loopFINDZ, 3, 2)))); </span><br/><span style="color: #FF0000">  1.04 </span><span style="color: #0000FF">  12176 </span><span style="color: #000000; font-weight: bold"> 485</span> <span style="color: #000000; background: #FFF0F0;">            planecoB = (((meshXYZ(loopFINDZ, 3, 1) * (meshXYZ(loopFINDZ, 1, 2) - meshXYZ(loopFINDZ, 1, 3))) + (meshXYZ(loopFINDZ, 3, 2) * (meshXYZ(loopFINDZ, 1, 3) - meshXYZ(loopFINDZ, 1, 1)))) + (meshXYZ(loopFINDZ, 3, 3) * (meshXYZ(loopFINDZ, 1, 1) - meshXYZ(loopFINDZ, 1, 2)))); </span><br/><span style="color: #FF0000">  0.81 </span><span style="color: #0000FF">  12176 </span><span style="color: #000000; font-weight: bold"> 486</span> <span style="color: #000000; background: #FFFFFF;">            planecoC = (((meshXYZ(loopFINDZ, 1, 1) * (meshXYZ(loopFINDZ, 2, 2) - meshXYZ(loopFINDZ, 2, 3))) + (meshXYZ(loopFINDZ, 1, 2) * (meshXYZ(loopFINDZ, 2, 3) - meshXYZ(loopFINDZ, 2, 1)))) + (meshXYZ(loopFINDZ, 1, 3) * (meshXYZ(loopFINDZ, 2, 1) - meshXYZ(loopFINDZ, 2, 2)))); </span><br/><span style="color: #FF0000">  1.04 </span><span style="color: #0000FF">  12176 </span><span style="color: #000000; font-weight: bold"> 487</span> <span style="color: #000000; background: #FFF0F0;">            planecoD = ((((-meshXYZ(loopFINDZ, 1, 1)) * ((meshXYZ(loopFINDZ, 2, 2) * meshXYZ(loopFINDZ, 3, 3)) - (meshXYZ(loopFINDZ, 2, 3) * meshXYZ(loopFINDZ, 3, 2)))) - (meshXYZ(loopFINDZ, 1, 2) * ((meshXYZ(loopFINDZ, 2, 3) * meshXYZ(loopFINDZ, 3, 1)) - (meshXYZ(loopFINDZ, 2, 1) * meshXYZ(loopFINDZ, 3, 3))))) - (meshXYZ(loopFINDZ, 1, 3) * ((meshXYZ(loopFINDZ, 2, 1) * meshXYZ(loopFINDZ, 3, 2)) - (meshXYZ(loopFINDZ, 2, 2) * meshXYZ(loopFINDZ, 3, 1))))); </span><br/><span style="color: #FF0000">  0.16 </span><span style="color: #0000FF">  12176 </span><span style="color: #000000; font-weight: bold"> 488</span> <span style="color: #000000; background: #FFFFFF;">            if (abs(planecoC) &lt; 1e-14) </span><br/>               <span style="color: #A0A0A0"> 489</span> <span style="color: #A0A0A0; background: #FFFFFF;">              planecoC = 0;</span><br/>               <span style="color: #A0A0A0"> 490</span> <span style="color: #A0A0A0; background: #FFFFFF;">            end</span><br/><span style="color: #FF0000">  0.49 </span><span style="color: #0000FF">  12176 </span><span style="color: #000000; font-weight: bold"> 491</span> <span style="color: #000000; background: #FFFFFF;">            gridCOzCROSS((facetCROSSLIST == loopFINDZ)) = ((((-planecoD) - (planecoA * gridCOx(loopX))) - (planecoB * gridCOy(loopY))) / planecoC); </span><br/><span style="color: #FF0000">  0.13 </span><span style="color: #0000FF">  12176 </span><span style="color: #000000; font-weight: bold"> 492</span> <span style="color: #000000; background: #FFFFFF;">          end </span><br/>               <span style="color: #A0A0A0"> 493</span> <span style="color: #228B22; background: #FFFFFF;">%Remove values of gridCOzCROSS which are outside of the mesh limits (including a 1e-12 margin for error).</span><br/><span style="color: #FF0000">  0.23 </span><span style="color: #0000FF">   7330 </span><span style="color: #000000; font-weight: bold"> 494</span> <span style="color: #000000; background: #FFFFFF;">          gridCOzCROSS = gridCOzCROSS(((gridCOzCROSS &gt;= (meshZmin - 1e-12)) &amp; (gridCOzCROSS &lt;= (meshZmax + 1e-12)))); </span><br/>               <span style="color: #A0A0A0"> 495</span> <span style="color: #228B22; background: #FFFFFF;">%Round gridCOzCROSS to remove any rounding errors, and take only the unique values:</span><br/><span style="color: #FF0000">  0.13 </span><span style="color: #0000FF">   7330 </span><span style="color: #000000; font-weight: bold"> 496</span> <span style="color: #000000; background: #FFFFFF;">          gridCOzCROSS = (round((gridCOzCROSS * 1e12)) / 1e12); </span><br/><span style="color: #FF0000">  3.47 </span><span style="color: #0000FF">   7330 </span><span style="color: #000000; font-weight: bold"> 497</span> <a name="Line497"></a><span style="color: #000000; background: #FFD4D4;">          gridCOzCROSS = <a href="file8.html">unique</a>(gridCOzCROSS); </span><br/>               <span style="color: #A0A0A0"> 498</span> <span style="color: #228B22; background: #FFFFFF;">%----------</span><br/>               <span style="color: #A0A0A0"> 499</span> <span style="color: #228B22; background: #FFFFFF;">% - 4 - Label as being inside the mesh all the voxels that the ray passes through after crossing one facet before crossing another facet:</span><br/>               <span style="color: #A0A0A0"> 500</span> <span style="color: #228B22; background: #FFFFFF;">%----------</span><br/><span style="color: #FF0000">  0.26 </span><span style="color: #0000FF">   7330 </span><span style="color: #000000; font-weight: bold"> 501</span> <span style="color: #000000; background: #FFFFFF;">          if (rem(numel(gridCOzCROSS), 2) == 0) </span><br/>               <span style="color: #A0A0A0"> 502</span> <span style="color: #228B22; background: #FFFFFF;">% Only rays which cross an even number of facets are voxelised</span><br/>       <span style="color: #0000FF">   7330 </span><span style="color: #000000; font-weight: bold"> 503</span> <span style="color: #000000; background: #FFFFFF;">            AM_tmpAS_loopASSIGN = (1 : (numel(gridCOzCROSS) / 2)); </span><br/><span style="color: #FF0000">  0.16 </span><span style="color: #0000FF">   7330 </span><span style="color: #000000; font-weight: bold"> 504</span> <span style="color: #000000; background: #FFFFFF;">            for AM_tmpFS_loopASSIGN = (1 : length(AM_tmpAS_loopASSIGN(:, :))) </span><br/><span style="color: #FF0000">  0.10 </span><span style="color: #0000FF">   6088 </span><span style="color: #000000; font-weight: bold"> 505</span> <span style="color: #000000; background: #FFFFFF;">              loopASSIGN = AM_tmpAS_loopASSIGN(:, AM_tmpFS_loopASSIGN); </span><br/><span style="color: #FF0000">  0.03 </span><span style="color: #0000FF">   6088 </span><span style="color: #000000; font-weight: bold"> 506</span> <span style="color: #000000; background: #FFFFFF;">              voxelsINSIDE = ((gridCOz &gt; gridCOzCROSS(((2 * loopASSIGN) - 1))) &amp; (gridCOz &lt; gridCOzCROSS((2 * loopASSIGN)))); </span><br/><span style="color: #FF0000">  0.13 </span><span style="color: #0000FF">   6088 </span><span style="color: #000000; font-weight: bold"> 507</span> <span style="color: #000000; background: #FFFFFF;">              gridOUTPUT(loopX, loopY, voxelsINSIDE) = 1; </span><br/><span style="color: #FF0000">  0.10 </span><span style="color: #0000FF">   6088 </span><span style="color: #000000; font-weight: bold"> 508</span> <span style="color: #000000; background: #FFFFFF;">            end </span><br/>               <span style="color: #A0A0A0"> 509</span> <span style="color: #A0A0A0; background: #FFFFFF;">          elseif (numel(gridCOzCROSS) ~= 0)</span><br/>               <span style="color: #A0A0A0"> 510</span> <span style="color: #228B22; background: #FFFFFF;">% Remaining rays which meet the mesh in some way are not voxelised, but are labelled for correction later.</span><br/>               <span style="color: #A0A0A0"> 511</span> <span style="color: #A0A0A0; background: #FFFFFF;">            AM_CVar_7 = [correctionLIST; loopX, loopY];</span><br/>               <span style="color: #A0A0A0"> 512</span> <span style="color: #A0A0A0; background: #FFFFFF;">            correctionLIST = AM_CVar_7;</span><br/>               <span style="color: #A0A0A0"> 513</span> <span style="color: #A0A0A0; background: #FFFFFF;">            AM_GLOBAL.arrayGrowingAspect.arrayGrowingAspect_actCor(AM_CVar_7);</span><br/>               <span style="color: #A0A0A0"> 514</span> <span style="color: #A0A0A0; background: #FFFFFF;">          end  %if</span><br/><span style="color: #FF0000">  0.13 </span><span style="color: #0000FF">   7330 </span><span style="color: #000000; font-weight: bold"> 515</span> <span style="color: #000000; background: #FFFFFF;">        end </span><br/><span style="color: #FF0000">  0.16 </span><span style="color: #0000FF">   7330 </span><span style="color: #000000; font-weight: bold"> 516</span> <span style="color: #000000; background: #FFFFFF;">      end  %if </span><br/><span style="color: #FF0000">  0.03 </span><span style="color: #0000FF">   7700 </span><span style="color: #000000; font-weight: bold"> 517</span> <span style="color: #000000; background: #FFFFFF;">    end </span><br/>       <span style="color: #0000FF">    152 </span><span style="color: #000000; font-weight: bold"> 518</span> <span style="color: #000000; background: #FFFFFF;">  end </span><br/>               <span style="color: #A0A0A0"> 519</span> <span style="color: #228B22; background: #FFFFFF;">%======================================================</span><br/>               <span style="color: #A0A0A0"> 520</span> <span style="color: #228B22; background: #FFFFFF;">% USE INTERPOLATION TO FILL IN THE RAYS WHICH COULD NOT BE VOXELISED</span><br/>               <span style="color: #A0A0A0"> 521</span> <span style="color: #228B22; background: #FFFFFF;">%======================================================</span><br/>               <span style="color: #A0A0A0"> 522</span> <span style="color: #228B22; background: #FFFFFF;">%For rays where the voxelisation did not give a clear result, the ray is</span><br/>               <span style="color: #A0A0A0"> 523</span> <span style="color: #228B22; background: #FFFFFF;">%computed by interpolating from the surrounding rays.</span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 524</span> <span style="color: #000000; background: #FFFFFF;">  countCORRECTIONLIST = size(correctionLIST, 1); </span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 525</span> <span style="color: #000000; background: #FFFFFF;">  if (countCORRECTIONLIST &gt; 0) </span><br/>               <span style="color: #A0A0A0"> 526</span> <span style="color: #228B22; background: #FFFFFF;">%If necessary, add a one-pixel border around the x and y edges of the</span><br/>               <span style="color: #A0A0A0"> 527</span> <span style="color: #228B22; background: #FFFFFF;">%array.  This prevents an error if the code tries to interpolate a ray at</span><br/>               <span style="color: #A0A0A0"> 528</span> <span style="color: #228B22; background: #FFFFFF;">%the edge of the x,y grid.</span><br/>               <span style="color: #A0A0A0"> 529</span> <span style="color: #A0A0A0; background: #FFFFFF;">    if ((((min(correctionLIST(:, 1)) == 1) || (max(correctionLIST(:, 1)) == numel(gridCOx))) || (min(correctionLIST(:, 2)) == 1)) || (max(correctionLIST(:, 2)) == numel(gridCOy)))</span><br/>               <span style="color: #A0A0A0"> 530</span> <span style="color: #A0A0A0; background: #FFFFFF;">      gridOUTPUT = [zeros(1, (voxcountY + 2), voxcountZ); zeros(voxcountX, 1, voxcountZ), gridOUTPUT, zeros(voxcountX, 1, voxcountZ); zeros(1, (voxcountY + 2), voxcountZ)];</span><br/>               <span style="color: #A0A0A0"> 531</span> <span style="color: #A0A0A0; background: #FFFFFF;">      AM_CVar_8 = (correctionLIST + 1);</span><br/>               <span style="color: #A0A0A0"> 532</span> <span style="color: #A0A0A0; background: #FFFFFF;">      correctionLIST = AM_CVar_8;</span><br/>               <span style="color: #A0A0A0"> 533</span> <span style="color: #A0A0A0; background: #FFFFFF;">      AM_GLOBAL.arrayGrowingAspect.arrayGrowingAspect_actCor(AM_CVar_8);</span><br/>               <span style="color: #A0A0A0"> 534</span> <span style="color: #A0A0A0; background: #FFFFFF;">    end</span><br/>               <span style="color: #A0A0A0"> 535</span> <span style="color: #A0A0A0; background: #FFFFFF;">    AM_tmpAS_loopC = (1 : countCORRECTIONLIST);</span><br/>               <span style="color: #A0A0A0"> 536</span> <span style="color: #A0A0A0; background: #FFFFFF;">    for AM_tmpFS_loopC = (1 : length(AM_tmpAS_loopC(:, :)))</span><br/>               <span style="color: #A0A0A0"> 537</span> <span style="color: #A0A0A0; background: #FFFFFF;">      loopC = AM_tmpAS_loopC(:, AM_tmpFS_loopC);</span><br/>               <span style="color: #A0A0A0"> 538</span> <span style="color: #A0A0A0; background: #FFFFFF;">      voxelsforcorrection = squeeze(sum([gridOUTPUT((correctionLIST(loopC, 1) - 1), (correctionLIST(loopC, 2) - 1), :), gridOUTPUT((correctionLIST(loopC, 1) - 1), correctionLIST(loopC, 2), :), gridOUTPUT((correctionLIST(loopC, 1) - 1), (correctionLIST(loopC, 2) + 1), :), gridOUTPUT(correctionLIST(loopC, 1), (correctionLIST(loopC, 2) - 1), :), gridOUTPUT(correctionLIST(loopC, 1), (correctionLIST(loopC, 2) + 1), :), gridOUTPUT((correctionLIST(loopC, 1) + 1), (correctionLIST(loopC, 2) - 1), :), gridOUTPUT((correctionLIST(loopC, 1) + 1), correctionLIST(loopC, 2), :), gridOUTPUT((correctionLIST(loopC, 1) + 1), (correctionLIST(loopC, 2) + 1), :)]));  ...</span><br/>               <span style="color: #A0A0A0"> 539</span> <span style="color: #228B22; background: #FFFFFF;">      ...</span><br/>               <span style="color: #A0A0A0"> 540</span> <span style="color: #228B22; background: #FFFFFF;">      ...</span><br/>               <span style="color: #A0A0A0"> 541</span> <span style="color: #228B22; background: #FFFFFF;">      ...</span><br/>               <span style="color: #A0A0A0"> 542</span> <span style="color: #228B22; background: #FFFFFF;">      ...</span><br/>               <span style="color: #A0A0A0"> 543</span> <span style="color: #228B22; background: #FFFFFF;">      ...</span><br/>               <span style="color: #A0A0A0"> 544</span> <span style="color: #228B22; background: #FFFFFF;">      ...</span><br/>               <span style="color: #A0A0A0"> 545</span> <span style="color: #228B22; background: #FFFFFF;">      ...</span><br/>               <span style="color: #A0A0A0"> 546</span> <span style="color: #A0A0A0; background: #FFFFFF;">      voxelsforcorrection = (voxelsforcorrection &gt;= 4);</span><br/>               <span style="color: #A0A0A0"> 547</span> <span style="color: #A0A0A0; background: #FFFFFF;">      gridOUTPUT(correctionLIST(loopC, 1), correctionLIST(loopC, 2), voxelsforcorrection) = 1;</span><br/>               <span style="color: #A0A0A0"> 548</span> <span style="color: #A0A0A0; background: #FFFFFF;">    end</span><br/>               <span style="color: #A0A0A0"> 549</span> <span style="color: #228B22; background: #FFFFFF;">%Remove the one-pixel border surrounding the array, if this was added</span><br/>               <span style="color: #A0A0A0"> 550</span> <span style="color: #228B22; background: #FFFFFF;">%previously.</span><br/>               <span style="color: #A0A0A0"> 551</span> <span style="color: #A0A0A0; background: #FFFFFF;">    if ((size(gridOUTPUT, 1) &gt; numel(gridCOx)) || (size(gridOUTPUT, 2) &gt; numel(gridCOy)))</span><br/>               <span style="color: #A0A0A0"> 552</span> <span style="color: #A0A0A0; background: #FFFFFF;">      gridOUTPUT = gridOUTPUT((2 : (end - 1)), (2 : (end - 1)), :);</span><br/>               <span style="color: #A0A0A0"> 553</span> <span style="color: #A0A0A0; background: #FFFFFF;">    end</span><br/>               <span style="color: #A0A0A0"> 554</span> <span style="color: #A0A0A0; background: #FFFFFF;">  end  %if</span><br/>               <span style="color: #A0A0A0"> 555</span> <span style="color: #228B22; background: #FFFFFF;">%disp([' Ray tracing result: ',num2str(countCORRECTIONLIST),' rays (',num2str(countCORRECTIONLIST/(voxcountX*voxcountY)*100,'%5.1f'),'% of all rays) exactly crossed a facet edge and had to be computed by interpolation.'])</span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 556</span> <span style="color: #000000; background: #FFFFFF;">  if AM_EntryPoint_1 </span><br/>               <span style="color: #A0A0A0"> 557</span> <span style="color: #A0A0A0; background: #FFFFFF;">    AM_GLOBAL = [];</span><br/>               <span style="color: #A0A0A0"> 558</span> <span style="color: #A0A0A0; background: #FFFFFF;">  end</span><br/>               <span style="color: #A0A0A0"> 559</span> <span style="color: #228B22; background: #FFFFFF;">%function</span><br/>       <span style="color: #0000FF">      3 </span><span style="color: #000000; font-weight: bold"> 560</span> <span style="color: #000000; background: #FFFFFF;">end </span><br/></pre><p><p>Other subfunctions in this file are not included in this listing.</body></html>